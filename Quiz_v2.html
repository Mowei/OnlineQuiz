<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>線上測驗（合併版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }

    .quiz-container {
      max-width: 600px;
      margin: auto;
    }

    #question {
      text-align: left;
    }

    .option {
      display: block;
      margin: 10px 0;
      text-align: left;
    }

    .result {
      margin-top: 20px;
      font-weight: bold;
      text-align: left;
    }

    .score {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
    }

    .green {
      color: green;
    }

    .red {
      color: red;
    }
  </style>
</head>
<body>

  <h2>線上測驗（讀取 merged.json）</h2>

  <div>
    <input type="file" id="fileInput">
    <button onclick="loadMergedFile()">讀取 merged.json</button>
  </div>

  <p class="score" id="score" style="display: none;">分數: 0</p>
  <p class="result" id="result"></p>

  <div id="quiz" class="quiz-container" style="display:none;">
    <h3>測試題目：</h3>
    <p id="question"></p>
    <div id="options"></div>
    <button onclick="submitAnswer()">提交答案</button>
  </div>

  <script>
    let questions = [];
    let userAnser = [];
    let currentQuestionIndex = 0;
    let score = 0;

    function loadMergedFile() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) {
        alert("請選擇 merged.json 檔案");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        questions = JSON.parse(event.target.result);
        currentQuestionIndex = 0;
        //localStorage.removeItem("USER_ANSER");
        document.getElementById("result").innerHTML = "";
        document.getElementById("quiz").style.display = "block";
        loadQuestion();
      };
      reader.readAsText(file);
    }

    function loadQuestion() {
      if (currentQuestionIndex >= questions.length) {
        evaluateResults();
        return;
      }

      const quiz = questions[currentQuestionIndex];
      document.getElementById("question").textContent = (currentQuestionIndex + 1) + ". " + quiz.question;
      const optionsDiv = document.getElementById("options");
      optionsDiv.innerHTML = "";

      quiz.options.forEach(option => {
        const label = document.createElement("label");
        label.classList.add("option");
        label.innerHTML = `<input type="radio" name="answer" value="${option.key}"> ${option.key}.${option.value}`;
        optionsDiv.appendChild(label);
      });

      restoreSelection();
    }

    function submitAnswer() {
      const selected = document.querySelector('input[name="answer"]:checked');
      if (!selected) {
        alert("請選擇一個答案！");
        return;
      }

      SetUserAnser(currentQuestionIndex, selected.value);
      currentQuestionIndex++;
      loadQuestion();
    }

    function evaluateResults() {
      userAnser = GetUserAnser();
      score = 0;
      document.getElementById("result").innerHTML = "錯誤題目:<br />";

      userAnser.forEach(userAns => {
        const quiz = questions.find(q => parseInt(q.question_number) === userAns.key);
        const correctAns = quiz.answer;

        const title = document.createElement("div");
        title.classList.add("quiz-result");
        title.innerHTML = `<div> ${quiz.question_number}. ${quiz.question} </div>`;

        quiz.options.forEach(option => {
          const div = document.createElement("div");

          if (correctAns.includes(option.key)) {
            div.innerHTML = `O ${option.key}. ${option.value}`;
            div.classList.add("green");
          } else if (option.key === userAns.value) {
            div.innerHTML = `X ${option.key}. ${option.value}`;
            div.classList.add("red");
          } else {
            div.innerHTML = `${option.key}. ${option.value}`;
          }

          title.appendChild(div);
        });

        document.getElementById("result").appendChild(title);
        document.getElementById("result").appendChild(document.createElement("br"));

        if (correctAns.includes(userAns.value)) {
          score += 100 / questions.length;
        }
      });

      updateScore();
    }

    function updateScore() {
      document.getElementById("quiz").style.display = "none";
      document.getElementById("score").textContent = "分數: " + Math.round(score);
      document.getElementById("score").style.display = "block";
    }

    function GetUserAnser() {
      return (localStorage.getItem('USER_ANSER')) ? JSON.parse(localStorage.getItem('USER_ANSER')) : [];
    }

    function SetUserAnser(index, value) {
      userAnser = GetUserAnser();
      userAnser = userAnser.filter(x => x.key !== (index + 1));
      userAnser.push({ key: index + 1, value: value });
      localStorage.setItem("USER_ANSER", JSON.stringify(userAnser));
    }

    function restoreSelection() {
      userAnser = GetUserAnser();
      const savedAnswer = userAnser.find(x => x.key === currentQuestionIndex + 1);

      if (savedAnswer) {
        const radioButtons = document.querySelectorAll('input[name="answer"]');
        radioButtons.forEach(radio => {
          if (radio.value === savedAnswer.value) {
            radio.checked = true;
          }
        });
      }
    }
  </script>
</body>
</html>
